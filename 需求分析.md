# 需求分析

## 1. 核心用例图 (Core Use Case Diagram)

系统的功能边界，重点突出“人机协同”这一核心需求。

```mermaid
graph TB
    %% 定义用户（置顶）
    User[fa:fa-user 用户<br/>Web开发者/设计师]

    %% --- 区域 1: 项目管理（垂直堆叠） ---
    subgraph "项目管理"
        PM_Manage[管理项目] 
        PM_Manage --> PM_Create[创建新项目]
        PM_Create --> PM_Status[查看项目状态]
        PM_Status --> PM_Import[导入/导出中间结果]
        PM_Import --> PM_Export[导出项目配置]
    end

    %% --- 区域 2: 图像处理与分析（垂直堆叠） ---
    subgraph "图像处理与分析"
        IA_Upload[上传UI截图]
        IA_Upload --> IA_Trigger[触发AI自动化分析]
        IA_Trigger --> IA_Progress[查看异步分析进度]
    end

    %% --- 区域 3: 可视化编辑器 (人机协同核心，垂直堆叠) ---
    subgraph "可视化编辑器<br/>人机协同核心"
        VE_HumanLoop[人工修正识别结果]
        VE_HumanLoop --> VE_EditType[修正组件类型]
        VE_EditType --> VE_EditGeo[调整几何信息]
        VE_EditGeo --> VE_EditAttr[编辑视觉属性]
        VE_EditAttr --> VE_SaveComp[保存组件到库]
        VE_SaveComp --> VE_LoadComp[从组件库加载]
        VE_LoadComp --> VE_ManageLib[管理组件库]
    end

    %% --- 区域 4: 代码生成（垂直堆叠） ---
    subgraph "代码生成"
        CG_SelectTech[选择技术栈]
        CG_SelectTech --> CG_SelectLib[选择组件库]
        CG_SelectLib --> CG_Config[配置出码选项]
        CG_Config --> CG_Preview[代码预览]
        CG_Preview --> CG_Download[下载代码包]
    end

    %% --- 系统内部动作 ---
    subgraph "系统内部"
        SYS_Validate[图像预处理与校验]
    end

    %% --- 顶层关系（自顶向下） ---
    User --> PM_Manage
    User --> IA_Upload
    User --> VE_HumanLoop
    User --> CG_Config

    %% 链接跨区关系，保持垂直流向
    PM_Manage --> IA_Upload
    IA_Trigger -.-> IA_Progress
    IA_Progress --> VE_HumanLoop
    VE_ManageLib --> CG_SelectTech
    CG_Config --> CG_Preview

    %% 系统内部连接
    IA_Upload --> SYS_Validate

    classDef userClass fill:#e1f5fe,stroke:#01579b,stroke-width:2px
    classDef processClass fill:#fff3e0,stroke:#e65100,stroke-width:2px
    classDef aiClass fill:#e8f5e9,stroke:#1b5e20,stroke-width:2px
    classDef humanClass fill:#fff8e1,stroke:#f57c00,stroke-width:2px

    class User userClass
    class PM_Manage,PM_Create,PM_Status,PM_Import,PM_Export processClass
    class IA_Upload,IA_Trigger,IA_Progress,SYS_Validate aiClass
    class VE_HumanLoop,VE_EditType,VE_EditGeo,VE_EditAttr,VE_SaveComp,VE_LoadComp,VE_ManageLib humanClass
    class CG_SelectTech,CG_SelectLib,CG_Config,CG_Preview,CG_Download processClass

```

---

## 2. 高层业务流程图 (High-Level Business Process Flow)

用户操作、前端响应和后端 AI 异步处理之间的时序关系。

```mermaid
graph TD
    %% 定义样式
    classDef userAction fill:#e1f5fe,stroke:#01579b,stroke-width:2px,color:#01579b;
    classDef frontendSystem fill:#fff3e0,stroke:#e65100,stroke-width:2px,color:#e65100;
    classDef backendAI fill:#e8f5e9,stroke:#1b5e20,stroke-width:2px,color:#1b5e20;

    %% --- 阶段 1: 开始与上传 ---
    Start((开始)) --> U_Login[用户登录/进入工作台]:::userAction
    U_Login --> U_CreateProj[创建项目并设置状态为Draft]:::userAction
    U_CreateProj --> U_Status[查看项目状态]:::userAction
    U_Status --> U_Upload[拖拽上传UI截图]:::userAction
    U_Upload --> F_Validate{前端校验：格式/大小?}:::frontendSystem
    F_Validate -- 不通过 --> U_Upload
    F_Validate -- 通过 --> B_Preprocess[后端接收并预处理图像]:::backendAI

    %% --- 阶段 2: 自动化分析 (异步) ---
    B_Preprocess --> B_StartTask[启动异步AI分析任务]:::backendAI
    B_StartTask -- 返回TaskID --> F_ShowProgress[前端显示进度条：轮询状态]:::frontendSystem

    subgraph "后端 AI 算法流水线 (Python微服务)"
        B_StartTask -.-> AI_SAM[1. SAM 分割定位]:::backendAI
        AI_SAM -.-> AI_ResNet[2. ResNet 元素分类]:::backendAI
        AI_ResNet -.-> AI_Feat[3. 视觉特征提取]:::backendAI
        AI_Feat -.-> B_GenJSON[生成初始 JSON 中间表示]:::backendAI
    end

    B_GenJSON -.-> F_ShowProgress
    F_ShowProgress -- 分析完成 --> F_LoadEditor[加载可视化编辑器：渲染 DOM 树]:::frontendSystem

    %% --- 阶段 3: 人机协同修正 (核心) ---
    F_LoadEditor --> U_EditLoop{用户人工修正：Human-in-the-Loop}:::userAction
    U_EditLoop -- 调整类型/位置/属性 --> F_UpdateJSON[实时更新前端 JSON 数据]:::frontendSystem
    F_UpdateJSON --> U_EditLoop
    U_EditLoop --> U_SaveComp[保存组件到个人库]:::userAction
    U_SaveComp --> U_LoadComp[从组件库加载组件]:::userAction
    U_LoadComp --> U_EditLoop
    U_EditLoop -- 确认无误 --> U_StatusUpdate[更新项目状态为Completed]:::userAction
    U_StatusUpdate --> U_Config[配置出码选项]:::userAction

    %% --- 阶段 4: 生成与交付 ---
    U_Config --> U_SelectTech[选择技术栈：React/Vue/HTML]:::userAction
    U_SelectTech --> U_SelectLib[选择组件库：AntD/ElementPlus等]:::userAction
    U_SelectLib --> F_RequestGen[请求代码生成]:::frontendSystem
    F_RequestGen --> B_CodeGen[后端 DSL 引擎：基于模板映射转换JSON为代码]:::backendAI
    B_CodeGen --> F_Preview[前端代码预览（Monaco Editor）]:::frontendSystem
    F_Preview --> U_Download[下载完整工程ZIP包]:::userAction
    U_Download --> U_Export[导出项目中间结果（可选）]:::userAction
    U_Export --> End((结束))

    %% 图例
    subgraph 图例
        L1(用户动作):::userAction
        L2(前端系统动作):::frontendSystem
        L3(后端/AI服务动作):::backendAI
    end

```

## 3. 核心功能特性详述

### 3.1 项目状态管理

- **状态流转**：Draft → Analyzing → Completed
- **状态同步**：项目状态与当前活跃任务状态联动
- **状态可视化**：前端实时展示项目进展状态

### 3.2 多阶段AI分析过程

- **阶段1：图像分割** (SAM) - 定位组件边界
- **阶段2：元素分类** (ResNet) - 识别24种组件类型
- **阶段3：特征提取** - 提取8种核心视觉特征
- **进度追踪**：前端通过WebSocket/轮询获取各阶段进度
- **阶段结果存储**：分阶段保存中间结果，支持断点续传

### 3.3 组件库管理系统

- **组件保存**：用户可将编辑好的组件保存到个人库
- **组件复用**：从组件库快速加载常用组件组合
- **组件分类**：支持标签和分类管理
- **组件分享**：支持公开分享高质量组件
- **使用统计**：记录组件使用频率，优化推荐

### 3.4 智能代码生成引擎

- **技术栈选择**：React (UmiJS/Next.js)、Vue 3、原生HTML/CSS
- **组件库映射**：自动映射到对应的UI组件库
- **模板系统**：基于JSON中间表示的DSL转换引擎
- **代码预览**：集成Monaco Editor进行语法高亮预览
- **工程交付**：生成包含完整项目结构的ZIP包

### 3.5 数据导出导入功能

- **中间结果导出**：导出JSON格式的组件坐标、类型、样式数据
- **跨设备迁移**：支持导入中间结果继续编辑
- **版本控制**：记录导出历史，支持多版本管理
- **调试支持**：便于开发阶段的数据分析和问题排查
