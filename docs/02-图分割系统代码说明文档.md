# 图分割系统代码说明文档

## 1 文档编写目的

描述源代码存放目录结构，指导读者阅读、查找系统源代码中的内容；

描述源代码编译方法、使用的编译工具、指导使用者顺利完成编译；

## 2 代码存放目录说明

服务器地址：http://43.247.90.210:5056

表1 项目目录说明表

| 文件夹 | 文件 | 说明 |
|--------|------|------|
| sam_path | 无 | SAM模型存放目录 |
|  | `sam_vit_h_4b8939.pth` | SAM模型 |
| img_seg | 无 | 项目数据、代码存放目录 |
| img_seg/segment_anything | 无 | SAM模型源码 |
| img_seg/data | 无 | ResNet模型训练数据存放目录 |
| img_seg/data/Bar | 无 | ResNet模型Bar类型组件训练数据存放目录 |
|  | `Bar_1.jpg` | Bar类型组件训练数据 |
| img_seg/model | 无 | ResNet模型存放目录 |
|  | `Train-imgSeg-1.pth` | ResNet模型 |
| img_seg/trainInfo | 无 | ResNet模型训练信息存放目录 |
|  | `Train-imgSeg-1.json` | Train-imgSeg-1模型训练信息 |
| img_seg/samPredictInfo | 无 | SAM推理信息存放目录 |
| img_seg/samPredictInfo/user_1 | 无 | 用户user_1使用SAM推理生成数据存放目录 |
|  | `samPredict_1` | SAM推理任务samPredict_1生成的分割图片数据 |
| img_seg/resnetPredictInfo | 无 | ResNet模型推理信息存放目录 |
| img_seg/resnetPredictInfo/user_1 | 无 | 用户user_1使用ResNet推理生成数据存放目录 |
|  | `resnetPredict_1` | ResNet推理任务resnetPredict_1生成的组件预测数据 |
| _pycache | 无 | Python缓存文件夹 |
| img_seg | `config.py` | resnet参数python文件 |
|  | `imgseg_config.py` | 图分割API参数python文件 |
|  | `data_loader.py` | ResNet模型加载训练数据python文件 |
|  | `model.py` | ResNet模型定义python文件 |
|  | `train.py` | ResNet模型训练python文件 |
|  | `imgSegAPI.py` | 图分割APIpython文件 |
|  | `imgseg_gradio.py` | 图分割后台界面python文件 |
|  | `api.out` | 推理、训练API输出 |
|  | `gradio.out` | 后台界面输出 |

## 3 部署说明

1. 创建用户：`adduser ImgSeg`；

2. 更改用户权限。按照 [https://zhuanlan.zhihu.com/p/143388819](https://zhuanlan.zhihu.com/p/143388819) 更改；

3. 切换到新建用户。将Anaconda安装包拷贝到服务器（`Anaconda3-2023.03-1-Linux-x86_64.sh`）；

4. cd到anaconda目录下，使用bash命令执行Anaconda.sh。（`bash Anaconda3-2023.03-1-Linux-x86_64.sh`）；

5. 将Anaconda环境变量添加到配置文件。在终端输入`sudo gedit ~/.bashrc`，在最后一行中输入anaconda的bin文件路径，`export PATH="/home/ImgSeg/anaconda3/bin:$PATH"`（中间路径部分需要根据bin文件路径修改）；

6. 然后Ctrl+S保存配置文件，在终端中输入：`source ~/.bashrc`；

7. 在终端输入`conda env list`，测试是否配置成功；

8. 将`ImageSeg.yml`拷贝到服务器上，创建虚拟环境：`conda env create -f ImageSeg.yml`；

9. 将项目代码拷贝到服务器上（提供代码压缩包），并按照如下目录分别存放SAM模型和项目代码。

   `sam_pth`文件夹下存放SAM模型，`img_seg`文件夹下存放项目代码；

10. 为项目代码选择虚拟环境，在PyCharm中打开项目，文件→设置→项目→Python解释器，右边选择新增解释器，点击添加，选择conda环境，在现有环境中手动选择解释器，找到之前安装的虚拟环境位置（`/home/ImgSeg/anaconda3/envs/ImageSeg/`），选择对应的python可执行文件，点击确认。

## 4 编译说明

推理、训练API脚本：ImgSegAPI.py

后台界面脚本：imgseg_gradio.py

1. 切换为ImgSeg用户：
   ```bash
   su ImgSeg
   ```

2. 激活ImageSeg虚拟环境，切换到项目文件夹：
   ```bash
   conda activate ImageSeg
   cd /path/to/imgsegnew-main/img_seg
   ```

3. 添加环境变量：
   ```bash
   export no_proxy=localhost,fslgpu01,fslgpu02,10.100.14.77,10.100.13.184,10.100.13.13,10.100.222.31,10.100.222.30,127.0.0.1
   export LD_LIBRARY_PATH=/home/data/root/anaconda3/envs/ImageSeg/lib:$LD_LIBRARY_PATH
   ```

4. 推理API脚本启动命令：
   ```bash
   nohup python3 ImgSegAPI.py --device 0 --port 9002 --default_model_id Train-imgSeg-52ddfff5-6e6e-4e83-955a-94783d83613a >api.out 2>&1 &
   ```

参数说明：
- `--device`: 显卡号（可选，默认使用CUDA_VISIBLE_DEVICES环境变量）
- `--port`: 端口号（可选，默认9002）
- `--default_model_id`: ResNet默认模型ID（可选）
- `>api.out 2>&1 &`: 将输出日志重定向到api.out文件

5. 后台界面脚本启动命令：
   ```bash
   nohup python3 imgseg_gradio.py >gradio.out 2>&1 &
   ```

- **API文档**: http://localhost:9002/docs
- **ReDoc文档**: http://localhost:9002/redoc
- **Gradio界面**: http://localhost:9006

## 5 构件资源包

无

## 文档修订记录

| 修订版本号 | 修订人 | 修订日期 | 修订描述 |
|-----------|--------|----------|----------|
| v1.0 | 初始版本 | 2023 | 初始版本 |

---

**文档版本**: v1.0
**最后更新**: 2023-01-21
